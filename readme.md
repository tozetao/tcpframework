### 应用层数据单位

客户端于服务端通信的数据单位称为一个消息（Message），一个消息体由头部和内容体组成，它是经典的TLY结构，即Type-Len-Value。

头部为8个字节，分别是4个字节的消息id和4个字节的消息体长度组成，消息体是具体的数据，它的长度对应头部的消息体长度。



### 源码文件说明

- Connection

  客户端连接的处理抽象为Connection，负责调度Request和Response对象来处理请求。

- Request

  请求处理抽象为Request，它负责解读连接数据。

- Response

  响应处理抽象为Response，它负责响应连接数据。

- Message

  消息体，应用层数据单位。

- MessageHandler

  消息处理者，负责将连接发过来的消息加入到任务队列中，交由Worker对象处理。

- Worker

  没有对用文件，它是一个概念。

  业务逻辑的处理抽象为Worker，一个Worker负责处理一个Connection的具体业务逻辑，它会调用消息体对应的路由对象来处理消息体。



### 框架执行过程

框架默认会启动一个Worker池和一个任务队列，任务队列存储着多个待处理的业务逻辑 ，而每个Worker负责从任务队列中取出各自的任务来进行处理。

因此处理一个连接的具体过程有：

- 客户端建立连接后，实例化Connection，负责处理连接。

- Request对象负责读数据，将数据解包为一个消息体，并将消息体交给MessageHandler对象，由它加入到任务队列中。
- Worker池中的每个Worker会监听消息队列中的任务，如果发现有对应的消息体要处理，则会都队列中取出任务，并调用消息体对应的路由对象来处理。
- 在处理完毕后，将结果写入到数据通道中，由Response对象响应给客户端结果。











设计缺陷：

由于是使用连接ID来作为轮询的算法，因此一个Worker会处理多个连接分派的任务。

如果在处理一个连接的任务发生阻塞时，后续的所有任务都会发生阻塞。

因此写逻辑代码需要非常小心，注意不要写出阻塞的程序。



Bug：

每个Worker都是一个协程；处理一个连接会开启三个协程，Connection一个协程，Request一个协程，Response一个协程。

如果某个任务处理阻塞了，在客户端断开连接时，这时候会做一些资源清理，包括数据通道、客户端连接等资源。当清理动作完成后，如果这时候任务恢复执行，往已经关闭的数据通道写入数据将会引发异常。

